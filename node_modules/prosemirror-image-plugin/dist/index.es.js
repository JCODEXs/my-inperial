import{DecorationSet as t,Decoration as e}from"prosemirror-view";import{PluginKey as n,TextSelection as i,Plugin as a}from"prosemirror-state";var o,l,s;!function(t){t.left="left",t.right="right",t.center="center",t.fullWidth="fullWidth"}(o||(o={})),function(t){t.top="top",t.topRight="topRight",t.right="right",t.bottomRight="bottomRight",t.bottom="bottom",t.bottomLeft="bottomLeft",t.left="left",t.topLeft="topLeft"}(l||(l={})),function(t){t.imageResizeBoxWrapper="imageResizeBoxWrapper",t.imageResizeBoxCenter="imageResizeBoxCenter",t.imageResizeBox="imageResizeBox",t.imageResizeBoxControl="imageResizeBoxControl",t.imagePluginRoot="imagePluginRoot",t.imagePluginImg="imagePluginImg"}(s||(s={}));const r=new n("imagePlugin"),d=(t,e,n,i,a,o)=>{const l={},{tr:s}=t.state;s.selection.empty||o||s.deleteSelection();const d={type:"add",pos:o||s.selection.from,id:l};s.setMeta(r,d),t.dispatch(s),i.uploadFile(e).then((e=>{const o=i.findPlaceholder(t.state,l);if(null==o)return;const s={type:"remove",id:l};t.dispatch(t.state.tr.insert(o,a.nodes.image.create({src:e,alt:n},i.hasTitle?a.text(i.defaultTitle):void 0)).setMeta(r,s))}),(()=>{t.dispatch(s.setMeta(r,{remove:{id:l}}))}))},c=(t,e,n)=>Math.max(Math.min(n,e),t),u={uploadFile:t=>new Promise((e=>setTimeout((()=>{const n=new FileReader;n.addEventListener("load",(()=>{const{result:t}=n;t&&e(t.toString())})),n.readAsDataURL(t)}),200))),hasTitle:!0,deleteSrc:()=>Promise.resolve(),extraAttributes:{align:o.center,width:null,height:null,maxWidth:null},createOverlay:()=>{const t=document.createElement("div");t.className="imagePluginOverlay";const e=document.createElement("button");e.className="alignLeftButton";const n=document.createElement("button");n.className="alignRightButton";const i=document.createElement("button");i.className="alignCenterButton";const a=document.createElement("button");return a.className="alignFullWidthButton",e.textContent=o.left,e.setAttribute("imagealign",o.left),n.textContent=o.right,n.setAttribute("imagealign",o.right),i.textContent=o.center,i.setAttribute("imagealign",o.center),a.textContent=o.fullWidth,a.setAttribute("imagealign",o.fullWidth),t.appendChild(e),t.appendChild(n),t.appendChild(i),t.appendChild(a),t},updateOverlay:(t,e,n,i)=>{t instanceof HTMLDivElement&&Object.values(o).map((a=>{const o=t.querySelector(`button[imagealign=${a}]`);return o instanceof HTMLButtonElement&&(o.onclick=((t,e,n,i)=>()=>{const a="function"==typeof e?e():0,o=n.state.tr.setNodeMarkup(a,void 0,Object.assign(Object.assign({},i.attrs),{align:t}));n.dispatch(o)})(a,e,n,i)),null}))},defaultTitle:"Image title",defaultAlt:"Image",enableResize:!0,isBlock:!0,resizeCallback:(t,e)=>{const n=new ResizeObserver((()=>e()));return n.observe(t),()=>{n.unobserve(t)}},imageMargin:50,minSize:50,maxSize:2e3,scaleImage:!0,createState:()=>({init:()=>t.empty,apply(t,n){let i=n.map(t.mapping,t.doc);const a=t.getMeta(r);if("add"===(null==a?void 0:a.type)){const n=document.createElement("placeholder"),o=e.widget(a.pos,n,{id:a.id});i=i.add(t.doc,[o])}else"remove"===(null==a?void 0:a.type)&&(i=i.remove(i.find(void 0,void 0,(t=>t.id===a.id))));return i}}),createDecorations:e=>r.getState(e)||t.empty,findPlaceholder:(t,e)=>{const n=r.getState(t),i=null==n?void 0:n.find(void 0,void 0,(t=>t.id===e));return(null==i?void 0:i.length)?i[0].from:void 0}};var m=(t,e)=>(n,i)=>{var a,o,l;const s=null===(a=null==i?void 0:i.dataTransfer)||void 0===a?void 0:a.getData("text/html"),r=null===(l=null===(o=null==i?void 0:i.dataTransfer)||void 0===o?void 0:o.files)||void 0===l?void 0:l[0],c=n.posAtCoords({top:i.clientY,left:i.clientX});if(s&&c){const a=document.createElement("div");a.innerHTML=s;const o=a.children[0];if(!(o instanceof HTMLImageElement)||o.dataset.pmSlice)return!1;if(1===a.children.length&&o instanceof HTMLImageElement){const i=((t,e)=>{var n,i;const a=t.split(","),o=null===(i=null===(n=a[0])||void 0===n?void 0:n.match(/:(.*?);/))||void 0===i?void 0:i[1],l=atob(a[1]);let s=l.length;const r=new Uint8Array(s);for(;s--;)r[s]=l.charCodeAt(s);return new File([r],e,{type:o})})(o.src,encodeURIComponent(o.alt||"dragged image"));d(n,i,t.defaultAlt,t,e,c.pos)}return i.preventDefault(),i.stopPropagation(),!0}return!(!r||!c)&&(d(n,r,t.defaultAlt,t,e,c.pos),i.preventDefault(),i.stopPropagation(),!0)};function g(t,e,n,i){return new(n||(n=Promise))((function(a,o){function l(t){try{r(i.next(t))}catch(t){o(t)}}function s(t){try{r(i.throw(t))}catch(t){o(t)}}function r(t){var e;t.done?a(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(l,s)}r((i=i.apply(t,e||[])).next())}))}const p=(t,e,n)=>{t.style.height=`${n}px`},h=(t,e)=>{t.style.width=`${e}px`},v=(t,e,n)=>{t.style.height=`${n}px`,t.style.width=`${e}px`},f={[l.left]:h,[l.topLeft]:v,[l.top]:p,[l.topRight]:v,[l.right]:h,[l.bottomRight]:v,[l.bottom]:p,[l.bottomLeft]:v},b=(t,e,n,i,a,o,r,d,u)=>{const m=document.createElement("span");m.className=`${s.imageResizeBoxControl} ${e}`,m.addEventListener("mousedown",((t,e,n,i,a,o,s,r,d,u)=>n=>{n.preventDefault(),n.stopPropagation(),r(!0),e.classList.add(t),e.classList.add("active");const m=n.clientX,g=n.clientY,p=e.clientWidth,h=e.clientHeight,b=p/h,x=n=>{n.preventDefault(),n.stopPropagation(),requestAnimationFrame((()=>{const i="center"===a.attrs.align&&t!==l.top&&t!==l.bottom,o=(m-n.clientX)*(/left/i.test(t)?1:-1)*(i?2:1),r=(g-n.clientY)*(/top/i.test(t)?1:-1)*(i?2:1);let x=c(u.minSize,Math.round(p+o),d),y=c(u.minSize,Math.round(h+r),u.maxSize);const w=f[t];w===v&&(y=Math.max(x/b,u.minSize),x=y*b);const O=e.parentElement;O&&(w(s,x,y),w(O,x,y),w(e,x,y))}))};document.addEventListener("mousemove",x),document.addEventListener("mouseup",(n=>{if(n.preventDefault(),n.stopPropagation(),r(!1),document.removeEventListener("mousemove",x),e.classList.remove(t),e.classList.remove("active"),"function"!=typeof i)return;const a=i();if(!a)return;const l=o.state.doc.nodeAt(i());if("image"!==(null==l?void 0:l.type.name))return;const s=Object.assign(Object.assign({},l.attrs),{width:e.clientWidth,height:e.clientHeight,maxWidth:d}),c=o.state.tr.setNodeMarkup(a,void 0,s);o.dispatch(c)}),{once:!0})})(e,t,0,n,i,a,o,r,d,u)),t.appendChild(m)};var x=(t,e)=>{var n,i;const{imageMargin:a,minSize:o,maxSize:l}=e;let s=t.parentElement;for(;s&&!s.offsetParent;)s=s.parentElement;const r=(null==s?void 0:s.classList.contains("ProseMirror"))?s:null==s?void 0:s.offsetParent;if(r instanceof HTMLElement&&(null==r?void 0:r.offsetWidth)>0){const l=null===(i=null===(n=null==t?void 0:t.ownerDocument)||void 0===n?void 0:n.defaultView)||void 0===i?void 0:i.getComputedStyle(r);let s=r.clientWidth-2*a;if("border-box"===(null==l?void 0:l.boxSizing)){s-=parseInt(l.paddingLeft,10)+parseInt(l.paddingRight,10)}return Math.min(Math.max(s,o),e.maxSize)}return l},y=(t,e,n,i,a,o,l,s)=>{const r=n&&i?n/i:1,d=a.scaleImage&&s?t/s:null;let c=d&&o?o*d:o,u=d&&l?l*d:l;return c&&!u?u=c/r:u&&!c?c=u*r:c||u||(c=n,u=i),c&&c>e&&(c=e,u=c/r),void 0===c||void 0===u?{height:a.minSize,width:a.minSize}:{width:c,height:u}};const w=t=>(e,n,a)=>{let o;const r=document.createElement("div");r.className=s.imagePluginRoot;const d=document.createElement("img");d.className=s.imagePluginImg;let c=!1;const u=t=>{c=t};let m;r.appendChild(d),Object.keys(e.attrs).map((t=>r.setAttribute(`imageplugin-${t}`,e.attrs[t])));const p=t.hasTitle&&document.createElement("div");p&&(p.className="imagePluginContent",p.addEventListener("click",(t=>{!a||"function"!=typeof a||p.innerText.length>1||(t.preventDefault(),n.dispatch(n.state.tr.setSelection(i.near(n.state.doc.resolve(a()+1)))),n.focus())})),p.className="text",r.appendChild(p));const h=t.createOverlay(e,a,n);let v;h&&(r.appendChild(h),t.updateOverlay(h,a,n,e)),d.alt=e.attrs.alt;const f=()=>{if(c)return;if("function"!=typeof a||t.enableResize&&!m)return;const e=a(),i=n.state.doc.nodeAt(e);if(i&&(Object.keys(i.attrs).map((t=>r.setAttribute(`imageplugin-${t}`,i.attrs[t]))),t.enableResize&&m)){const e=x(r,t),o=y(e,e,m.width,m.height,t,i.attrs.width,i.attrs.height,i.attrs.maxWidth);d.style.height=`${o.height}px`,d.style.width=`${o.width}px`,v&&v.remove(),v=((t,e,n,i,a,o,r,d,c)=>{const u=document.createElement("div");u.className=s.imageResizeBoxWrapper;const m=document.createElement("div");u.appendChild(m),m.className=s.imageResizeBoxCenter,m.style.height=`${t}px`,m.style.width=`${e}px`;const g=document.createElement("div");return m.appendChild(g),g.className=s.imageResizeBox,g.style.height=`${t}px`,g.style.width=`${e}px`,Object.keys(l).map((t=>b(g,l[t],n,i,a,o,r,d,c))),u})(o.height,o.width,a,i,n,d,u,e,t),r.appendChild(v)}};let w;return g(void 0,void 0,void 0,(function*(){var i;o=yield((t,e,n,i,a)=>g(void 0,void 0,void 0,(function*(){if(e.downloadImage){if(e.downloadPlaceholder){if(e.enableResize&&n.attrs.width&&n.attrs.height){const a=x(i,e),o=y(a,a,n.attrs.width,n.attrs.height,e,n.attrs.width,n.attrs.height);t.style.height=`${o.height}px`,t.style.width=`${o.width}px`}t.src=e.downloadPlaceholder(n.attrs.src,a)}return e.downloadImage(n.attrs.src)}return n.attrs.src})))(d,t,e,r,n),t.enableResize&&(m=yield(i=o,g(void 0,void 0,void 0,(function*(){const t=new Image,e=yield new Promise((e=>{t.onload=()=>e(!0),t.onerror=()=>e(!1),t.src=i}));return{width:t.naturalWidth,height:t.naturalHeight,completed:e}})))),d.src=o,f();const a=r.parentElement;a&&t.enableResize&&(w=t.resizeCallback(a,f))})),Object.assign(Object.assign({},p?{contentDOM:p,stopEvent:t=>t.target===p,selectable:!0,content:"text*"}:{}),{dom:r,update:e=>!("image"!==e.type.name||!o)&&(h&&t.updateOverlay(h,a,n,e),f(),!0),ignoreMutation:()=>!0,destroy:()=>{null==w||w(),t.deleteSrc(e.attrs.src)}})};var O=(t,e)=>(n,i)=>{var a,o;const l=null===(a=null==i?void 0:i.clipboardData)||void 0===a?void 0:a.items;if(!l)return!1;const s=Array.from(l).filter((t=>-1!==t.type.indexOf("image")));if(0===s.length)return!1;const r=s[0].getAsFile();return!!r&&(!(null===(o=null==i?void 0:i.clipboardData)||void 0===o?void 0:o.types.includes("text/rtf"))&&(d(n,r,t.defaultAlt,t,e),i.preventDefault(),!0))};const R=(t,e)=>new a({key:r,state:e.createState(e,t),props:{decorations:e.createDecorations,handleDOMEvents:{paste:O(e,t),drop:m(e,t)},nodeViews:{image:w(e)}}}),z=(t,e)=>{const{extraAttributes:n}=e,i=Object.keys(n).map((t=>({[t]:{default:n[t]||null}}))).reduce(((t,e)=>Object.assign(Object.assign({},t),e)),{}),a=[...Object.keys(n),"src","alt"];return t.update("image",Object.assign(Object.assign(Object.assign(Object.assign({},e.hasTitle?{content:"inline*"}:{}),{attrs:Object.assign({src:{default:null},alt:{default:null},height:{default:null},width:{default:null},maxWidth:{default:null}},i),atom:!0}),e.isBlock?{group:"block"}:{group:"inline",inline:!0}),{draggable:!0,toDOM(t){const n=a.map((e=>({[`imageplugin-${e}`]:t.attrs[e]}))).reduce(((t,e)=>Object.assign(Object.assign({},t),e)),{});return["div",Object.assign({class:"imagePluginRoot"},n),...e.hasTitle?[0]:[]]},parseDOM:[{tag:"div.imagePluginRoot",getAttrs:t=>"string"==typeof t?{}:a.map((e=>({[e]:t.getAttribute(`imageplugin-${e}`)}))).reduce(((t,e)=>Object.assign(Object.assign({},t),e)),{})}]}))};export{u as defaultSettings,o as imageAlign,R as imagePlugin,r as imagePluginKey,d as startImageUpload,z as updateImageNode};
