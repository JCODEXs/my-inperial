"use strict";var e,t,i,n=require("prosemirror-view"),a=require("prosemirror-state");exports.imageAlign=void 0,(e=exports.imageAlign||(exports.imageAlign={})).left="left",e.right="right",e.center="center",e.fullWidth="fullWidth",function(e){e.top="top",e.topRight="topRight",e.right="right",e.bottomRight="bottomRight",e.bottom="bottom",e.bottomLeft="bottomLeft",e.left="left",e.topLeft="topLeft"}(t||(t={})),function(e){e.imageResizeBoxWrapper="imageResizeBoxWrapper",e.imageResizeBoxCenter="imageResizeBoxCenter",e.imageResizeBox="imageResizeBox",e.imageResizeBoxControl="imageResizeBoxControl",e.imagePluginRoot="imagePluginRoot",e.imagePluginImg="imagePluginImg"}(i||(i={}));const o=new a.PluginKey("imagePlugin"),l=(e,t,i,n,a,l)=>{const s={},{tr:r}=e.state;r.selection.empty||l||r.deleteSelection();const d={type:"add",pos:l||r.selection.from,id:s};r.setMeta(o,d),e.dispatch(r),n.uploadFile(t).then((t=>{const l=n.findPlaceholder(e.state,s);if(null==l)return;const r={type:"remove",id:s};e.dispatch(e.state.tr.insert(l,a.nodes.image.create({src:t,alt:i},n.hasTitle?a.text(n.defaultTitle):void 0)).setMeta(o,r))}),(()=>{e.dispatch(r.setMeta(o,{remove:{id:s}}))}))},s=(e,t,i)=>Math.max(Math.min(i,t),e),r={uploadFile:e=>new Promise((t=>setTimeout((()=>{const i=new FileReader;i.addEventListener("load",(()=>{const{result:e}=i;e&&t(e.toString())})),i.readAsDataURL(e)}),200))),hasTitle:!0,deleteSrc:()=>Promise.resolve(),extraAttributes:{align:exports.imageAlign.center,width:null,height:null,maxWidth:null},createOverlay:()=>{const e=document.createElement("div");e.className="imagePluginOverlay";const t=document.createElement("button");t.className="alignLeftButton";const i=document.createElement("button");i.className="alignRightButton";const n=document.createElement("button");n.className="alignCenterButton";const a=document.createElement("button");return a.className="alignFullWidthButton",t.textContent=exports.imageAlign.left,t.setAttribute("imagealign",exports.imageAlign.left),i.textContent=exports.imageAlign.right,i.setAttribute("imagealign",exports.imageAlign.right),n.textContent=exports.imageAlign.center,n.setAttribute("imagealign",exports.imageAlign.center),a.textContent=exports.imageAlign.fullWidth,a.setAttribute("imagealign",exports.imageAlign.fullWidth),e.appendChild(t),e.appendChild(i),e.appendChild(n),e.appendChild(a),e},updateOverlay:(e,t,i,n)=>{e instanceof HTMLDivElement&&Object.values(exports.imageAlign).map((a=>{const o=e.querySelector(`button[imagealign=${a}]`);return o instanceof HTMLButtonElement&&(o.onclick=((e,t,i,n)=>()=>{const a="function"==typeof t?t():0,o=i.state.tr.setNodeMarkup(a,void 0,Object.assign(Object.assign({},n.attrs),{align:e}));i.dispatch(o)})(a,t,i,n)),null}))},defaultTitle:"Image title",defaultAlt:"Image",enableResize:!0,isBlock:!0,resizeCallback:(e,t)=>{const i=new ResizeObserver((()=>t()));return i.observe(e),()=>{i.unobserve(e)}},imageMargin:50,minSize:50,maxSize:2e3,scaleImage:!0,createState:()=>({init:()=>n.DecorationSet.empty,apply(e,t){let i=t.map(e.mapping,e.doc);const a=e.getMeta(o);if("add"===(null==a?void 0:a.type)){const t=document.createElement("placeholder"),o=n.Decoration.widget(a.pos,t,{id:a.id});i=i.add(e.doc,[o])}else"remove"===(null==a?void 0:a.type)&&(i=i.remove(i.find(void 0,void 0,(e=>e.id===a.id))));return i}}),createDecorations:e=>o.getState(e)||n.DecorationSet.empty,findPlaceholder:(e,t)=>{const i=o.getState(e),n=null==i?void 0:i.find(void 0,void 0,(e=>e.id===t));return(null==n?void 0:n.length)?n[0].from:void 0}};var d=(e,t)=>(i,n)=>{var a,o,s;const r=null===(a=null==n?void 0:n.dataTransfer)||void 0===a?void 0:a.getData("text/html"),d=null===(s=null===(o=null==n?void 0:n.dataTransfer)||void 0===o?void 0:o.files)||void 0===s?void 0:s[0],c=i.posAtCoords({top:n.clientY,left:n.clientX});if(r&&c){const a=document.createElement("div");a.innerHTML=r;const o=a.children[0];if(!(o instanceof HTMLImageElement)||o.dataset.pmSlice)return!1;if(1===a.children.length&&o instanceof HTMLImageElement){const n=((e,t)=>{var i,n;const a=e.split(","),o=null===(n=null===(i=a[0])||void 0===i?void 0:i.match(/:(.*?);/))||void 0===n?void 0:n[1],l=atob(a[1]);let s=l.length;const r=new Uint8Array(s);for(;s--;)r[s]=l.charCodeAt(s);return new File([r],t,{type:o})})(o.src,encodeURIComponent(o.alt||"dragged image"));l(i,n,e.defaultAlt,e,t,c.pos)}return n.preventDefault(),n.stopPropagation(),!0}return!(!d||!c)&&(l(i,d,e.defaultAlt,e,t,c.pos),n.preventDefault(),n.stopPropagation(),!0)};function c(e,t,i,n){return new(i||(i=Promise))((function(a,o){function l(e){try{r(n.next(e))}catch(e){o(e)}}function s(e){try{r(n.throw(e))}catch(e){o(e)}}function r(e){var t;e.done?a(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(l,s)}r((n=n.apply(e,t||[])).next())}))}const g=(e,t,i)=>{e.style.height=`${i}px`},m=(e,t)=>{e.style.width=`${t}px`},u=(e,t,i)=>{e.style.height=`${i}px`,e.style.width=`${t}px`},p={[t.left]:m,[t.topLeft]:u,[t.top]:g,[t.topRight]:u,[t.right]:m,[t.bottomRight]:u,[t.bottom]:g,[t.bottomLeft]:u},h=(e,n,a,o,l,r,d,c,g)=>{const m=document.createElement("span");m.className=`${i.imageResizeBoxControl} ${n}`,m.addEventListener("mousedown",((e,i,n,a,o,l,r,d,c,g)=>n=>{n.preventDefault(),n.stopPropagation(),d(!0),i.classList.add(e),i.classList.add("active");const m=n.clientX,h=n.clientY,v=i.clientWidth,f=i.clientHeight,x=v/f,b=n=>{n.preventDefault(),n.stopPropagation(),requestAnimationFrame((()=>{const a="center"===o.attrs.align&&e!==t.top&&e!==t.bottom,l=(m-n.clientX)*(/left/i.test(e)?1:-1)*(a?2:1),d=(h-n.clientY)*(/top/i.test(e)?1:-1)*(a?2:1);let b=s(g.minSize,Math.round(v+l),c),y=s(g.minSize,Math.round(f+d),g.maxSize);const w=p[e];w===u&&(y=Math.max(b/x,g.minSize),b=y*x);const A=i.parentElement;A&&(w(r,b,y),w(A,b,y),w(i,b,y))}))};document.addEventListener("mousemove",b),document.addEventListener("mouseup",(t=>{if(t.preventDefault(),t.stopPropagation(),d(!1),document.removeEventListener("mousemove",b),i.classList.remove(e),i.classList.remove("active"),"function"!=typeof a)return;const n=a();if(!n)return;const o=l.state.doc.nodeAt(a());if("image"!==(null==o?void 0:o.type.name))return;const s=Object.assign(Object.assign({},o.attrs),{width:i.clientWidth,height:i.clientHeight,maxWidth:c}),r=l.state.tr.setNodeMarkup(n,void 0,s);l.dispatch(r)}),{once:!0})})(n,e,0,a,o,l,r,d,c,g)),e.appendChild(m)};var v=(e,t)=>{var i,n;const{imageMargin:a,minSize:o,maxSize:l}=t;let s=e.parentElement;for(;s&&!s.offsetParent;)s=s.parentElement;const r=(null==s?void 0:s.classList.contains("ProseMirror"))?s:null==s?void 0:s.offsetParent;if(r instanceof HTMLElement&&(null==r?void 0:r.offsetWidth)>0){const l=null===(n=null===(i=null==e?void 0:e.ownerDocument)||void 0===i?void 0:i.defaultView)||void 0===n?void 0:n.getComputedStyle(r);let s=r.clientWidth-2*a;if("border-box"===(null==l?void 0:l.boxSizing)){s-=parseInt(l.paddingLeft,10)+parseInt(l.paddingRight,10)}return Math.min(Math.max(s,o),t.maxSize)}return l},f=(e,t,i,n,a,o,l,s)=>{const r=i&&n?i/n:1,d=a.scaleImage&&s?e/s:null;let c=d&&o?o*d:o,g=d&&l?l*d:l;return c&&!g?g=c/r:g&&!c?c=g*r:c||g||(c=i,g=n),c&&c>t&&(c=t,g=c/r),void 0===c||void 0===g?{height:a.minSize,width:a.minSize}:{width:c,height:g}};const x=e=>(n,o,l)=>{let s;const r=document.createElement("div");r.className=i.imagePluginRoot;const d=document.createElement("img");d.className=i.imagePluginImg;let g=!1;const m=e=>{g=e};let u;r.appendChild(d),Object.keys(n.attrs).map((e=>r.setAttribute(`imageplugin-${e}`,n.attrs[e])));const p=e.hasTitle&&document.createElement("div");p&&(p.className="imagePluginContent",p.addEventListener("click",(e=>{!l||"function"!=typeof l||p.innerText.length>1||(e.preventDefault(),o.dispatch(o.state.tr.setSelection(a.TextSelection.near(o.state.doc.resolve(l()+1)))),o.focus())})),p.className="text",r.appendChild(p));const x=e.createOverlay(n,l,o);let b;x&&(r.appendChild(x),e.updateOverlay(x,l,o,n)),d.alt=n.attrs.alt;const y=()=>{if(g)return;if("function"!=typeof l||e.enableResize&&!u)return;const n=l(),a=o.state.doc.nodeAt(n);if(a&&(Object.keys(a.attrs).map((e=>r.setAttribute(`imageplugin-${e}`,a.attrs[e]))),e.enableResize&&u)){const n=v(r,e),s=f(n,n,u.width,u.height,e,a.attrs.width,a.attrs.height,a.attrs.maxWidth);d.style.height=`${s.height}px`,d.style.width=`${s.width}px`,b&&b.remove(),b=((e,n,a,o,l,s,r,d,c)=>{const g=document.createElement("div");g.className=i.imageResizeBoxWrapper;const m=document.createElement("div");g.appendChild(m),m.className=i.imageResizeBoxCenter,m.style.height=`${e}px`,m.style.width=`${n}px`;const u=document.createElement("div");return m.appendChild(u),u.className=i.imageResizeBox,u.style.height=`${e}px`,u.style.width=`${n}px`,Object.keys(t).map((e=>h(u,t[e],a,o,l,s,r,d,c))),g})(s.height,s.width,l,a,o,d,m,n,e),r.appendChild(b)}};let w;return c(void 0,void 0,void 0,(function*(){var t;s=yield((e,t,i,n,a)=>c(void 0,void 0,void 0,(function*(){if(t.downloadImage){if(t.downloadPlaceholder){if(t.enableResize&&i.attrs.width&&i.attrs.height){const a=v(n,t),o=f(a,a,i.attrs.width,i.attrs.height,t,i.attrs.width,i.attrs.height);e.style.height=`${o.height}px`,e.style.width=`${o.width}px`}e.src=t.downloadPlaceholder(i.attrs.src,a)}return t.downloadImage(i.attrs.src)}return i.attrs.src})))(d,e,n,r,o),e.enableResize&&(u=yield(t=s,c(void 0,void 0,void 0,(function*(){const e=new Image,i=yield new Promise((i=>{e.onload=()=>i(!0),e.onerror=()=>i(!1),e.src=t}));return{width:e.naturalWidth,height:e.naturalHeight,completed:i}})))),d.src=s,y();const i=r.parentElement;i&&e.enableResize&&(w=e.resizeCallback(i,y))})),Object.assign(Object.assign({},p?{contentDOM:p,stopEvent:e=>e.target===p,selectable:!0,content:"text*"}:{}),{dom:r,update:t=>!("image"!==t.type.name||!s)&&(x&&e.updateOverlay(x,l,o,t),y(),!0),ignoreMutation:()=>!0,destroy:()=>{null==w||w(),e.deleteSrc(n.attrs.src)}})};var b=(e,t)=>(i,n)=>{var a,o;const s=null===(a=null==n?void 0:n.clipboardData)||void 0===a?void 0:a.items;if(!s)return!1;const r=Array.from(s).filter((e=>-1!==e.type.indexOf("image")));if(0===r.length)return!1;const d=r[0].getAsFile();return!!d&&(!(null===(o=null==n?void 0:n.clipboardData)||void 0===o?void 0:o.types.includes("text/rtf"))&&(l(i,d,e.defaultAlt,e,t),n.preventDefault(),!0))};exports.defaultSettings=r,exports.imagePlugin=(e,t)=>new a.Plugin({key:o,state:t.createState(t,e),props:{decorations:t.createDecorations,handleDOMEvents:{paste:b(t,e),drop:d(t,e)},nodeViews:{image:x(t)}}}),exports.imagePluginKey=o,exports.startImageUpload=l,exports.updateImageNode=(e,t)=>{const{extraAttributes:i}=t,n=Object.keys(i).map((e=>({[e]:{default:i[e]||null}}))).reduce(((e,t)=>Object.assign(Object.assign({},e),t)),{}),a=[...Object.keys(i),"src","alt"];return e.update("image",Object.assign(Object.assign(Object.assign(Object.assign({},t.hasTitle?{content:"inline*"}:{}),{attrs:Object.assign({src:{default:null},alt:{default:null},height:{default:null},width:{default:null},maxWidth:{default:null}},n),atom:!0}),t.isBlock?{group:"block"}:{group:"inline",inline:!0}),{draggable:!0,toDOM(e){const i=a.map((t=>({[`imageplugin-${t}`]:e.attrs[t]}))).reduce(((e,t)=>Object.assign(Object.assign({},e),t)),{});return["div",Object.assign({class:"imagePluginRoot"},i),...t.hasTitle?[0]:[]]},parseDOM:[{tag:"div.imagePluginRoot",getAttrs:e=>"string"==typeof e?{}:a.map((t=>({[t]:e.getAttribute(`imageplugin-${t}`)}))).reduce(((e,t)=>Object.assign(Object.assign({},e),t)),{})}]}))};
